# Claude Code Action 要件定義書

## 1. システム概要

### 1.1 システム名
Claude Code Action（Claude コードアクション）

### 1.2 システムの目的
GitHub のプルリクエスト（PR）および Issue において、Claude AI が自動的に対応し、コードレビュー、質問回答、コード実装を行うことで、開発者の作業効率を向上させる。

### 1.3 対象範囲
- GitHub リポジトリ内のプルリクエスト
- GitHub リポジトリ内の Issue
- GitHub Actions による自動化処理
- Claude AI との統合

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 トリガー機能
- **要件ID**: FR-001
- **要件名**: コメントトリガー検知
- **説明**: 指定されたトリガーフレーズ（デフォルト: `@claude`）を含むコメントを検知し、アクションを開始する
- **対象イベント**:
  - issue_comment（Issue/PR コメント作成時）
  - pull_request_review_comment（PR レビューコメント作成時） 
  - pull_request_review（PR レビュー投稿時）
  - issues（Issue 作成時・アサイン時）
  - pull_request（PR 作成時・更新時）

#### 2.1.2 アクセス制御機能
- **要件ID**: FR-002
- **要件名**: ユーザー権限チェック
- **説明**: リポジトリへの書き込み権限を持つユーザーのみがアクションをトリガーできる
- **制限事項**:
  - GitHub App やボットはトリガー不可
  - 人間ユーザーのみ有効

#### 2.1.3 コード解析・レビュー機能
- **要件ID**: FR-003
- **要件名**: 自動コードレビュー
- **説明**: PR の変更内容を解析し、コードレビューを実施する
- **機能詳細**:
  - バグ、セキュリティ問題、パフォーマンス問題の検出
  - 可読性・保守性の改善提案
  - ベストプラクティス・コーディング規約のチェック
  - 具体的なファイルパス・行番号の参照

#### 2.1.4 質問応答機能
- **要件ID**: FR-004
- **要件名**: コードに関する質問応答
- **説明**: コードベースに関する質問に対して技術的で有用な回答を提供する
- **機能詳細**:
  - コードの動作説明
  - アーキテクチャの解説
  - 改善提案の提示

#### 2.1.5 コード実装機能
- **要件ID**: FR-005
- **要件名**: 自動コード実装
- **説明**: 要求に基づいてコードの変更・実装を行う
- **機能詳細**:
  - 簡単から中程度の複雑さのコード変更
  - 新機能の実装
  - バグ修正
  - リファクタリング

#### 2.1.6 ブランチ管理機能
- **要件ID**: FR-006
- **要件名**: スマートブランチ操作
- **説明**: コンテキストに応じた適切なブランチ操作を実行する
- **動作ルール**:
  - Issue でトリガー: 新しいブランチを作成
  - オープンな PR でトリガー: 既存の PR ブランチに直接プッシュ
  - クローズされた PR でトリガー: 新しいブランチを作成

#### 2.1.7 進捗追跡機能
- **要件ID**: FR-007
- **要件名**: 動的進捗表示
- **説明**: 作業進捗をチェックボックス形式で表示し、リアルタイムで更新する
- **機能詳細**:
  - TODO リストの自動生成
  - 完了項目の自動更新
  - 進行中インジケーターの表示

#### 2.1.8 コメント管理機能
- **要件ID**: FR-008
- **要件名**: 単一コメント更新
- **説明**: 1つの初期コメントのみを更新し、複数コメントは作成しない
- **制約事項**:
  - 新しいコメントの作成禁止
  - 既存コメントの更新のみ許可

### 2.2 非機能要件

#### 2.2.1 パフォーマンス要件
- **要件ID**: NFR-001
- **要件名**: 実行時間制限
- **説明**: デフォルト30分、最大タイムアウト設定可能
- **測定基準**: GitHub Actions の実行時間

#### 2.2.2 セキュリティ要件
- **要件ID**: NFR-002
- **要件名**: 認証・認可
- **説明**: 
  - GitHub App による短期間トークン使用
  - リポジトリスコープ内のみアクセス
  - API キーの安全な管理（GitHub Secrets 必須）
  - コミット署名の自動実行

#### 2.2.3 拡張性要件
- **要件ID**: NFR-003
- **要件名**: 複数クラウドプロバイダー対応
- **説明**: 以下の認証方式をサポート
  - Anthropic API 直接接続（デフォルト）
  - Amazon Bedrock（OIDC 認証）
  - Google Vertex AI（OIDC 認証）

#### 2.2.4 カスタマイズ要件
- **要件ID**: NFR-004
- **要件名**: 設定可能性
- **説明**: 
  - カスタムトリガーフレーズ設定
  - 許可・禁止ツールの設定
  - カスタム指示の追加
  - 環境変数の設定
  - MCP サーバー設定

## 3. システム制約事項

### 3.1 機能制約
- **制約ID**: CON-001
- **制約名**: GitHub 操作制限
- **内容**: 
  - 正式な PR レビューの投稿不可
  - PR の承認不可
  - 複数コメントの投稿不可
  - ブランチのマージ・リベース等の Git 操作不可
  - .github/workflows ディレクトリの変更不可

### 3.2 実行環境制約
- **制約ID**: CON-002
- **制約名**: 実行コンテキスト制限
- **内容**:
  - リポジトリ外のコマンド実行不可
  - CI/CD 結果の閲覧不可（追加ツール設定時を除く）
  - デフォルトでは Bash コマンド実行不可（明示的許可が必要）

### 3.3 会話制限
- **制約ID**: CON-003
- **制約名**: ターン数制限
- **内容**: `max_turns` パラメータによる会話ターン数の制限可能

## 4. アーキテクチャ

### 4.1 システム構成
```
GitHub Events → Trigger Detection → Context Gathering → AI Integration → Response Generation
```

### 4.2 主要コンポーネント

#### 4.2.1 トリガー検出システム
- **ファイル**: `src/github/validation/trigger.ts`
- **機能**: GitHub イベントからトリガー条件を判定
- **処理内容**: 
  - 直接プロンプト判定
  - アサイニー判定
  - コメント・本文内トリガーフレーズ検出

#### 4.2.2 データ取得システム
- **ファイル**: `src/github/data/fetcher.ts`
- **機能**: GitHub API からデータを取得
- **取得データ**:
  - PR/Issue 詳細情報
  - コメント一覧
  - 変更ファイル情報
  - レビューデータ
  - 画像の自動ダウンロード

#### 4.2.3 プロンプト生成システム
- **ファイル**: `src/create-prompt/index.ts`
- **機能**: Claude 向けのコンテキスト豊富なプロンプトを生成
- **生成内容**:
  - フォーマット済みコンテキスト
  - 許可・禁止ツール設定
  - カスタム指示の統合

#### 4.2.4 MCP サーバー統合
- **ファイル**: `src/mcp/install-mcp-server.ts`
- **機能**: GitHub MCP サーバーのセットアップと設定
- **提供機能**:
  - ファイル操作（コミット、削除）
  - コメント更新
  - 拡張ツール統合

### 4.3 データフロー

1. **イベント受信**: GitHub webhook がアクションをトリガー
2. **準備フェーズ**: 
   - GitHub トークン設定
   - 権限チェック
   - トリガー条件確認
   - 初期コメント作成
3. **データ収集**: GitHub API からコンテキストデータを取得
4. **ブランチ設定**: 適切なブランチの作成/選択
5. **プロンプト生成**: Claude 向けの詳細なプロンプト作成
6. **AI 実行**: Claude Code の実行
7. **結果反映**: コメント更新とジョブリンクの追加

## 5. 外部連携

### 5.1 GitHub API 連携
- **API バージョン**: GitHub API v4 (GraphQL)
- **認証方式**: GitHub App トークン
- **必要権限**:
  - Contents: Read/Write
  - Pull Requests: Read/Write  
  - Issues: Read/Write

### 5.2 Claude AI 連携
- **プロバイダー**:
  - Anthropic API（直接）
  - Amazon Bedrock
  - Google Vertex AI
- **使用ベースアクション**: `anthropics/claude-code-base-action`

### 5.3 MCP プロトコル連携
- **SDK**: `@modelcontextprotocol/sdk`
- **組み込みサーバー**: GitHub File Operations
- **拡張性**: カスタム MCP サーバー対応

## 6. 運用要件

### 6.1 セットアップ要件
- リポジトリ管理者権限
- GitHub App のインストール
- API キーの Secrets 設定
- ワークフローファイルの配置

### 6.2 監視・ログ要件
- GitHub Actions のログ監視
- 実行時間の監視
- エラー発生時の通知

### 6.3 保守・運用要件
- API キーの定期ローテーション
- 短期間トークンの自動管理
- セキュリティ更新の適用

## 7. 今後の拡張計画

### 7.1 機能拡張
- より多くの GitHub イベント対応
- repository_dispatch イベント対応
- workflow_dispatch イベント対応

### 7.2 統合拡張
- より多くの MCP サーバー対応
- CI/CD システムとの統合強化
- 外部ツールとの連携拡張

---

**文書作成日**: 2025年6月19日  
**文書バージョン**: 1.0  
**作成者**: Claude AI  
**承認者**: [プロジェクトオーナー名]